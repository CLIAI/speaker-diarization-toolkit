# Speaker Detection Tools - Test Environment
#
# Provides reproducible testing with:
# - espeak-ng for synthetic voice generation
# - ffmpeg for audio processing
# - b3sum for blake3 hashing (optional, falls back to sha256)
# - All Python dependencies
#
# Usage:
#   docker build -f evals/Dockerfile.test -t speaker-tools-test .
#   docker run --rm speaker-tools-test
#   docker run --rm speaker-tools-test python evals/speaker_detection/test_e2e_pipeline.py
#   docker run --rm -e SPEECHMATICS_API_KEY="$KEY" speaker-tools-test
#
FROM python:3.11-slim

LABEL maintainer="CLIAI"
LABEL description="Test environment for speaker-* tool ecosystem"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    espeak-ng \
    ffmpeg \
    jq \
    make \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv for running speaker-* tools
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Note: b3sum (blake3) is optional - code falls back to sha256 if unavailable
# Skip b3sum installation to speed up builds (tests work without it)

# Python dependencies
WORKDIR /app

# Install Python packages (including rich for speaker-review TUI)
# These are needed for direct python execution and for uv cache warming
RUN pip install --no-cache-dir pyyaml requests rich

# Copy tools (order: least to most frequently changed)
# 1. Backend modules (rarely change)
COPY speaker_detection_backends/ ./speaker_detection_backends/

# 2. Original tools
COPY speaker_detection speaker_samples speaker_segments ./

# 3. New speaker-* tools
COPY speaker-catalog speaker-assign speaker-review ./
COPY speaker-llm speaker-process speaker-report ./

# 4. STT tools (if needed)
COPY stt_speechmatics.py ./

# Copy test infrastructure
COPY evals/ ./evals/

# Make all scripts executable
RUN chmod +x speaker_detection speaker_samples speaker_segments \
    speaker-catalog speaker-assign speaker-review \
    speaker-llm speaker-process speaker-report \
    evals/speaker_detection/*.py evals/speaker_detection/*.sh 2>/dev/null || true

# Test-specific environment - CRITICAL for isolation
ENV SPEAKERS_EMBEDDINGS_DIR=/tmp/test_speakers
ENV SPEAKER_DETECTION_DEBUG=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Create test directory
RUN mkdir -p /tmp/test_speakers

# Verify installation of all tools
RUN espeak-ng --version && \
    ffmpeg -version | head -1 && \
    python3 -c "import yaml; print('PyYAML OK')" && \
    python3 -c "import rich; print('Rich OK')" && \
    ./speaker_detection --help > /dev/null && \
    ./speaker_samples --help > /dev/null && \
    ./speaker-catalog --help > /dev/null && \
    ./speaker-assign --help > /dev/null && \
    ./speaker-review --help > /dev/null && \
    ./speaker-report --help > /dev/null && \
    echo "All tools verified OK"

# Generate test audio at build time
RUN cd evals/speaker_detection && make all

# Default: run all unit tests and e2e tests
WORKDIR /app
CMD ["sh", "-c", "./evals/speaker_detection/test_all.sh --unit && python evals/speaker_detection/test_e2e_pipeline.py"]
